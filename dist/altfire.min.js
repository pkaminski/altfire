(function(window, undefined){angular.module("altfire",[]).factory("fire",["$interpolate","$q","$parse","$timeout","orderByFilter",function(t,z,E,F,G){function x(a,b){if(a in r)return r[a];Object.keys(r).length>=H&&(r={});if(angular.isString(a)){var d="https://"===a.slice(0,8);if(a&&(-1!==(d?a.slice(8):a).indexOf("//")||"/"===a.charAt(a.length-1)||"/"===a.charAt(0))){try{throw Error("Invalid path interpolation: "+a);}catch(f){if(b)throw f;console.log(f.stack.replace(/\n[^\n]*(altfire|angular(\.min)?)\.js[^\n]*$/gm,""))}return r[a]=
null}if(!d){if(!u)throw Error("Relative path given and default root not specified.");a=r[a]=u+a}}return a}function I(a,b,d,f,g){function e(a){return[x(l?l(a):b,g),x(c?c(a):d,g)]}a.$watch||(g=!0);d&&-1===b.search("#")&&(b+="/#");var l=angular.isString(b)?t(b,!1):void 0,c=angular.isString(d)?t(d,!1):void 0;!g&&a.$watch&&a.$watch(e,function(a){h&&angular.equals(a,h)||(h=null,f.apply(null,a))},!0);var h=e(a);f.apply(null,h)}function v(a,b,d,f,g,e,l){function c(){e&&(n(e),k.allowedKeys={});"viaKeys"===
g||"viaValues"===g?angular.forEach(a[b],function(a,b){y([b],a)}):f&&y([],a[b]);v&&v();q&&q.destroy();delete a[b]}function h(a,b,c){var d=a.toString();w[d]||(w[d]={});w[d][b]||(w[d][b]=[]);w[d][b].push(c);a.on(b,c)}function n(a){var b=w[a.toString()];b&&angular.forEach(b,function(b,c){angular.forEach(b,function(b){a.off(c,b)})});delete w[a.toString()]}function J(){if("via"===g)h(e,"value",function(c){f&&(y([],a[b]),delete a[b]);k.filterValue=c.val();f=new Firebase(u.replace("#",c.val()));A([],r)});
else if("viaKeys"===g||"viaValues"===g)a[b]=a[b]||{},h(e,"value",function(a){k.filterValue=a.val();k.filterValue?angular.forEach(k.filterValue,function(a,b){p("viaKeys"===g?b:l(a),!0)}):B()}),h(e,"child_removed",function(a){p(a.name(),!1)});else if("viaIds"===g)if(a[b]=a[b]||{},k.filterValue=e,e.length)for(var c=0;c<e.length;c++)p(e[c],!0);else B()}function m(a,b){function c(d){d&&$rootScope.$emit("fire:error",k,{path:a,value:b,error:d})}if((k.isReady||angular.isObject(b))&&!angular.isUndefined(b)){var d=
t(a);b=D(b);angular.isObject(b)&&!angular.isArray(b)?d.update(b,c):d.set(b,c)}}function p(c,d){if(c&&!!k.allowedKeys[c]!==d)if(d)k.allowedKeys[c]=!0,A([c],s(c));else{var n=a[b]&&a[b][c];C("child_removed",[],c,n,!0);y([c],n);delete k.allowedKeys[c]}}function r(c){var n=function(){k.isReady?angular.isObject(c)&&angular.isObject(a[b])||(a[b]=c,q&&(q.savedScope[b]=angular.copy(c))):(a[b]=K(c,a[b]),B(),"bind"===d&&k.ready().then(function(){m([],a[b])}))};a.$evalAsync?a.$evalAsync(n):n()}function s(c){return function(d){angular.isObject(d)&&
angular.isObject(a[b]&&a[b][c])||angular.isUndefined(a[b])||(a[b][c]=d,q&&(q.savedScope[b][c]=angular.copy(d)),!k.isReady&&Object.keys(k.allowedKeys).every(function(c){return a[b].hasOwnProperty(c)})&&B(),k.isReady&&a.$evalAsync&&a.$evalAsync(function(){}))}}function B(){k.isReady||(k.isReady=!0,F(function(){x.resolve()}))}function t(a){var b;u&&"via"!==g?(b=new Firebase(u.replace("#",a[0])),1<a.length&&(b=b.child(a.slice(1).join("/")))):b=a.length?(f.ref?f.ref():f).child(a.join("/")):f;return b}
function A(a,b){function c(n){h(d,n,function(c){var d=c.name();c=c.val();switch(n){case "child_added":angular.isObject(c)&&A(a.concat(d));C(n,a,d,c,!0);break;case "child_changed":angular.isObject(c)||C(n,a,d,c,!0);break;case "child_removed":y(a.concat(d),c);C(n,a,d,c,!0);break;case "value":(b||angular.noop)(c)}})}a=a||[];var d=t(a);c("child_added");c("child_removed");c("child_changed");b&&c("value")}function y(a,c){a=a||[];var b=t(a);angular.isObject(c)&&angular.forEach(c,function(c,b){angular.isString(b)&&
"$"===b.charAt(0)||y(a.concat(b),c)});n(b)}function C(c,d,n,e,f){function g(){var l;l=E;for(var h=d,k=b,m=0,p=h.length;m<p;m++)k=angular.isNumber(h[m])?k+("["+h[m]+"]"):k+('["'+h[m].replace(/"/g,'\\"')+'"]');l=l(k);switch(c){case "child_removed":h=l(a);k=n;angular.isArray(h)?h.splice(k,1):h&&delete h[k];f&&q&&(l=l(q.savedScope),h=n,angular.copy(e),angular.isArray(l)?l.splice(h,1):l&&delete l[h]);break;case "child_added":case "child_changed":(h=l(a))&&(h[n]=e),f&&q&&(l=l(q.savedScope),h=angular.copy(e),
l&&(l[n]=h))}}a.$evalAsync?a.$evalAsync(g):g()}var k={},w={};l=l||angular.identity;var x=z.defer();a.$on&&a.$on("$destroy",c);k.destroy=c;k.isReady=!1;k.ready=function(){return x.promise};if(e){k.allowedKeys={};var u=f;f=null;J();k[g+"Ref"]=e}else A([],r),k.ref=f;var q,v;if("bind"===d){if(!a.$watch)throw Error("Can only bind to Angular scopes.");q=L(a,b,m);v=a.$watch(q.compare,angular.noop)}return k}function D(a){if(angular.isObject(a)){var b=angular.isArray(a)?Array(a.length):{},d;for(d in a)a.hasOwnProperty(d)&&
("$"!==d.charAt(0)&&angular.isDefined(a[d]))&&(angular.isObject(a[d])?b[d]=D(a[d]):b[d]=a[d]);return b}return a}function K(a,b){if(angular.equals(a,b))return b;if(angular.isArray(a)&&angular.isArray(b))return b.concat(a);if(angular.isObject(a)&&angular.isObject(b)){for(var d in a)b[d]=a[d];return b}return void 0!==a&&null!==a||!angular.isDefined(b)?a:b}function L(a,b,d){function f(a,c){void 0===c&&(c=null);a.shift();d(a,c)}function g(a,c,b,d,e){if(!b.charAt||"$"!==b.charAt(0)){e--;if(!e&&!angular.equals(a[b],
c[b]))return a[b]=angular.copy(c[b]),f(d.concat(b),c[b]);c=c[b];var m=a[b],p;if(angular.isObject(c))if(angular.isArray(c)){angular.isArray(m)||(f(d.concat(b),c),a[b]=m=c.slice());if(m.length>c.length)for(a=c.length,p=m.length;a<p;a++)f(d.concat(b,a),null);m.length=c.length;a=0;for(p=c.length;a<p;a++)g(m,c,a,d.concat(b),e)}else{if(!angular.isObject(m)||angular.isArray(m))f(d.concat(b),c),a[b]=m=angular.copy(c);for(p in c)c.hasOwnProperty(p)&&g(m,c,p,d.concat(b),e);for(p in m)c.hasOwnProperty(p)||(delete m[p],
f(d.concat(b,p),null))}else c!==m&&(a[b]=c,f(d.concat(b),c))}}var e={};e[b]=angular.copy(a[b]);return{savedScope:e,compare:function(){g(e,a,b,[],M)},destroy:function(){e&&delete e[b];e=null}}}var s={},u=null,r={},H=5E3,M=6;s.setDefaultRoot=function(a){angular.isString(a)||(a=a.toString());if(0!==a.search(/^https?:\/\//))throw Error("Firebase root URL must start with http(s)://, got: "+a);"/"!==a.charAt(a.length-1)&&(a+="/");u=a;r={}};s.ref=function(a,b){return new Firebase(x(t(b)(a)))};s.connectOne=
function(a){function b(b){a.query&&(b=a.query(b));return b}if(!a.name)throw Error("Must provide a name for the connection.");if(1!==("bind"in a)+("pull"in a)+("once"in a)+("noop"in a))throw Error('Each connection must specify exactly one of "bind", "pull", "once" and "noop".');var d,f;angular.forEach(["bind","pull","once","noop"],function(b){b in a&&(d=b,f=a[b])});var g="ref",e,l;angular.forEach(["via","viaKeys","viaValues","viaIds"],function(b){if(b in a){if(e)throw Error('A connection can specify at most one of "via", "viaKeys", "viaValues", and "viaIds".');
e=b;"viaIds"===b?g=null:(l=a[b],g=b+"Ref")}});if(e&&("once"===d||"noop"===d))throw Error('Cannot combine via* with "once" or "noop".');if(a.viaValueExtractor&&"viaValues"!==e)throw Error('Can only use "viaValueExtractor" with "viaValues".');if("viaIds"===e&&a.query)throw Error("Cannot combine viaIds with a query.");var c;I(a.pathScope||a.scope,f,l,function(f,h){c&&(c.destroy(),c=null);if("noop"===d&&f)c={destroy:angular.noop,isReady:!0,ready:function(){return z.when()}},c[g]=b(new Firebase(f));else if("once"===
d&&f){var m=z.defer(),p=c={destroy:angular.noop,isReady:!1,ready:function(){return m.promise}};c[g]=b(new Firebase(f));c[g].once("value",function(b){c===p&&(a.scope[a.name]=b.val(),c.isReady=!0,m.resolve())})}else!f||l&&!h||(c=h?v(a.scope,a.name,d,f,e,b(new Firebase(h)),a.viaValueExtractor):"viaIds"===e?v(a.scope,a.name,d,f,e,a.viaIds):v(a.scope,a.name,d,b(new Firebase(f))))});var h={destroy:function(){c&&c.destroy()},isReady:function(){return c&&c.isReady},ready:function(){return c&&c.ready()},allowedKeys:function(){return c&&
c.allowedKeys}};g&&(h[g]=function(){var a=c[g];a.ref&&(a=a.ref());arguments.length&&(a=a.child(Array.prototype.slice.call(arguments,0).join("/")));return a});e&&(h[e]=function(){return c.filterValue});return h};s.connect=function(a,b){var d={};angular.forEach(b,function(b,g){b.scope=a;b.name=g;d[g]=s.connectOne(b)});d.$allReady=function(){var b=[],g=[];angular.forEach(d,function(a,d){"$"!==d.charAt(0)&&(b.push(d),a.ready()&&g.push(a.ready()))});return z.all(g).then(function(){var d={};angular.forEach(b,
function(b){d[b]=a[b]});return d})};d.$destroyAll=function(){angular.forEach(d,function(a,b){"$"!==b.charAt(0)&&a.destroy()})};return d};s.toArrayOrderedByKey=function(a){var b=[];a&&(angular.forEach(a,function(a,f){angular.isObject(a)&&(a.$key=f,b.push(a))}),G(b,"$key"));return b};return s}]);}).call(window);
