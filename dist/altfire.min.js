(function(window, undefined){angular.module("altfire",[]).factory("fire",["$interpolate","$q","$parse","$timeout","orderByFilter",function(x,y,E,F,G){function s(a,b){if(angular.isString(a)){if(-1!==a.replace(/^https:\/\//,"").search("//")||"/"===a.charAt(a.length-1)){try{throw Error("Invalid path interpolation: "+a);}catch(d){if(b)throw d;console.debug(d.stack.replace(/\n[^\n]*(altfire|angular(\.min)?)\.js[^\n]*$/gm,""))}return null}if(-1===a.search(/^https?:\/\//)){if(a&&"/"===a.charAt(0))throw Error('Path must not start with a "/", got: '+
a);if(!v)throw Error("Relative path given and default root not specified.");a=v+a}}return a}function H(a,b,d,g,f){function e(a){return[s(m?m(a):b,f),s(c?c(a):d,f)]}a.$watch||(f=!0);d&&-1===b.search("#")&&(b+="/#");var m=angular.isString(b)?x(b,!1):void 0,c=angular.isString(d)?x(d,!1):void 0;!f&&a.$watch&&a.$watch(e,function(a,b){a!==b&&g.apply(null,a)},!0);g.apply(null,e(a))}function t(a,b,d,g,f,e,m){function c(){e&&(h(e),k.allowedKeys={});"viaKeys"===f||"viaValues"===f?angular.forEach(a[b],function(a,
b){w([b],a)}):g&&w([],a[b]);C&&C();q&&q.destroy();delete a[b]}function l(a,b,c){var d=a.toString();u[d]||(u[d]={});u[d][b]||(u[d][b]=[]);u[d][b].push(c);a.on(b,c)}function h(a){var b=u[a.toString()];b&&angular.forEach(b,function(b,c){angular.forEach(b,function(b){a.off(c,b)})});delete u[a.toString()]}function I(){if("via"===f)l(e,"value",function(c){g&&(w([],a[b]),delete a[b]);k.filterValue=c.val();g=new Firebase(t.replace("#",c.val()));z([],r)});else if("viaKeys"===f||"viaValues"===f)a[b]=a[b]||
{},l(e,"value",function(a){k.filterValue=a.val();k.filterValue?angular.forEach(k.filterValue,function(a,b){p("viaKeys"===f?b:m(a),!0)}):A()}),l(e,"child_removed",function(a){p(a.name(),!1)});else if("viaIds"===f)if(a[b]=a[b]||{},k.filterValue=e,e.length)for(var c=0;c<e.length;c++)p(e[c],!0);else A()}function n(a,b){function c(d){d&&$rootScope.$emit("fire:error",k,{path:a,value:b,error:d})}if((k.isReady||angular.isObject(b))&&!angular.isUndefined(b)){var d=s(a);b=D(b);angular.isObject(b)&&!angular.isArray(b)?
d.update(b,c):d.set(b,c)}}function p(c,d){if(c&&!!k.allowedKeys[c]!==d)if(d)k.allowedKeys[c]=!0,z([c],x(c));else{var h=a[b]&&a[b][c];B("child_removed",[],c,h,!0);w([c],h);delete k.allowedKeys[c]}}function r(c){var h=function(){k.isReady?angular.isObject(c)&&angular.isObject(a[b])||(a[b]=c,q&&(q.savedScope[b]=angular.copy(c))):(a[b]=J(c,a[b]),A(),"bind"===d&&k.ready().then(function(){n([],a[b])}))};a.$evalAsync?a.$evalAsync(h):h()}function x(c){return function(d){if(!angular.isObject(d)||!angular.isObject(a[b]&&
a[b][c])){var h=function(){angular.isUndefined(a[b])||(a[b][c]=d,q&&(q.savedScope[b][c]=angular.copy(d)),A())};a.$evalAsync?a.$evalAsync(h):h()}}}function A(){k.isReady||F(function(){k.isReady=!0;v.resolve()})}function s(a){var b;t&&"via"!==f?(b=new Firebase(t.replace("#",a[0])),1<a.length&&(b=b.child(a.slice(1).join("/")))):b=a.length?(g.ref?g.ref():g).child(a.join("/")):g;return b}function z(a,b){function c(h){l(d,h,function(c){var d=c.name();c=c.val();switch(h){case "child_added":angular.isObject(c)&&
z(a.concat(d));B(h,a,d,c,!0);break;case "child_changed":angular.isObject(c)||B(h,a,d,c,!0);break;case "child_removed":w(a.concat(d),c);B(h,a,d,c,!0);break;case "value":(b||angular.noop)(c)}})}a=a||[];var d=s(a);c("child_added");c("child_removed");c("child_changed");b&&c("value")}function w(a,c){a=a||[];var b=s(a);angular.isObject(c)&&angular.forEach(c,function(c,b){angular.isString(b)&&"$"===b.charAt(0)||w(a.concat(b),c)});h(b)}function B(c,d,h,e,f){function g(){var m;m=E;for(var l=d,k=b,n=0,p=l.length;n<
p;n++)k=angular.isNumber(l[n])?k+("["+l[n]+"]"):k+('["'+l[n].replace(/"/g,'\\"')+'"]');m=m(k);switch(c){case "child_removed":l=m(a);k=h;angular.isArray(l)?l.splice(k,1):l&&delete l[k];f&&q&&(m=m(q.savedScope),l=h,angular.copy(e),angular.isArray(m)?m.splice(l,1):m&&delete m[l]);break;case "child_added":case "child_changed":(l=m(a))&&(l[h]=e),f&&q&&(m=m(q.savedScope),l=angular.copy(e),m&&(m[h]=l))}}a.$evalAsync?a.$evalAsync(g):g()}var k={},u={};m=m||angular.identity;var v=y.defer();a.$on&&a.$on("$destroy",
c);k.destroy=c;k.isReady=!1;k.ready=function(){return v.promise};if(e){k.allowedKeys={};var t=g;g=null;I();k[f+"Ref"]=e}else z([],r),k.ref=g;var q,C;if("bind"===d){if(!a.$watch)throw Error("Can only bind to Angular scopes.");q=K(a,b,n);C=a.$watch(q.compare,angular.noop)}return k}function D(a){if(angular.isObject(a)){var b=angular.isArray(a)?Array(a.length):{},d;for(d in a)a.hasOwnProperty(d)&&("$"!==d.charAt(0)&&angular.isDefined(a[d]))&&(angular.isObject(a[d])?b[d]=D(a[d]):b[d]=a[d]);return b}return a}
function J(a,b){if(angular.equals(a,b))return b;if(angular.isArray(a)&&angular.isArray(b))return b.concat(a);if(angular.isObject(a)&&angular.isObject(b)){for(var d in a)b[d]=a[d];return b}return void 0!==a&&null!==a||!angular.isDefined(b)?a:b}function K(a,b,d){function g(a,c){void 0===c&&(c=null);a.shift();d(a,c)}function f(a,c,b,d,e){if(!b.charAt||"$"!==b.charAt(0)){e--;if(!e&&!angular.equals(a[b],c[b]))return a[b]=angular.copy(c[b]),g(d.concat(b),c[b]);c=c[b];var n=a[b],p;if(angular.isObject(c))if(angular.isArray(c)){angular.isArray(n)||
(g(d.concat(b),c),a[b]=n=c.slice());if(n.length>c.length)for(a=c.length,p=n.length;a<p;a++)g(d.concat(b,a),null);n.length=c.length;a=0;for(p=c.length;a<p;a++)f(n,c,a,d.concat(b),e)}else{if(!angular.isObject(n)||angular.isArray(n))g(d.concat(b),c),a[b]=n=angular.copy(c);for(p in c)c.hasOwnProperty(p)&&f(n,c,p,d.concat(b),e);for(p in n)c.hasOwnProperty(p)||(delete n[p],g(d.concat(b,p),null))}else c!==n&&(a[b]=c,g(d.concat(b),c))}}var e={};e[b]=angular.copy(a[b]);return{savedScope:e,compare:function(){f(e,
a,b,[],void 0)},destroy:function(){e&&delete e[b];e=null}}}var r={},v=null;r.setDefaultRoot=function(a){angular.isString(a)||(a=a.toString());if(0!==a.search(/^https?:\/\//))throw Error("Firebase root URL must start with http(s)://, got: "+a);"/"!==a.charAt(a.length-1)&&(a+="/");v=a};r.ref=function(a,b){return new Firebase(s(x(b)(a)))};r.connectOne=function(a){function b(b){a.query&&(b=a.query(b));return b}if(!a.name)throw Error("Must provide a name for the connection.");if(1!==("bind"in a)+("pull"in
a)+("once"in a)+("noop"in a))throw Error('Each connection must specify exactly one of "bind", "pull", "once" and "noop".');var d,g;angular.forEach(["bind","pull","once","noop"],function(b){b in a&&(d=b,g=a[b])});var f="ref",e,m;angular.forEach(["via","viaKeys","viaValues","viaIds"],function(b){if(b in a){if(e)throw Error('A connection can specify at most one of "via", "viaKeys", "viaValues", and "viaIds".');e=b;"viaIds"===b?f=null:(m=a[b],f=b+"Ref")}});if(e&&("once"===d||"noop"===d))throw Error('Cannot combine via* with "once" or "noop".');
if(a.viaValueExtractor&&"viaValues"!==e)throw Error('Can only use "viaValueExtractor" with "viaValues".');if("viaIds"===e&&a.query)throw Error("Cannot combine viaIds with a query.");var c;H(a.pathScope||a.scope,g,m,function(h,g){c&&(c.destroy(),c=null);if("noop"===d&&h)c={destroy:angular.noop,isReady:!0,ready:function(){return y.when()}},c[f]=b(new Firebase(h));else if("once"===d&&h){var l=y.defer(),p=c={destroy:angular.noop,isReady:!1,ready:function(){return l.promise}};c[f]=b(new Firebase(h));c[f].once("value",
function(b){c===p&&(a.scope[a.name]=b.val(),c.isReady=!0,l.resolve())})}else!h||m&&!g||(c=g?t(a.scope,a.name,d,h,e,b(new Firebase(g)),a.viaValueExtractor):"viaIds"===e?t(a.scope,a.name,d,h,e,a.viaIds):t(a.scope,a.name,d,b(new Firebase(h))))});var l={destroy:function(){c&&c.destroy()},isReady:function(){return c&&c.isReady},ready:function(){return c&&c.ready()},allowedKeys:function(){return c&&c.allowedKeys}};f&&(l[f]=function(){var a=c[f];a.ref&&(a=a.ref());arguments.length&&(a=a.child(Array.prototype.slice.call(arguments,
0).join("/")));return a});e&&(l[e]=function(){return c.filterValue});return l};r.connect=function(a,b){var d={};angular.forEach(b,function(b,f){b.scope=a;b.name=f;d[f]=r.connectOne(b)});d.$allReady=function(){var b=[],f=[];angular.forEach(d,function(a,d){"$"!==d.charAt(0)&&(b.push(d),a.ready()&&f.push(a.ready()))});return y.all(f).then(function(){var d={};angular.forEach(b,function(b){d[b]=a[b]});return d})};d.$destroyAll=function(){angular.forEach(d,function(a,b){"$"!==b.charAt(0)&&a.destroy()})};
return d};r.toArrayOrderedByKey=function(a){var b=[];a&&(angular.forEach(a,function(a,g){angular.isObject(a)&&(a.$key=g,b.push(a))}),G(b,"$key"));return b};return r}]);}).call(window);
